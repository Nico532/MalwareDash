package sample.logic;

import javafx.animation.AnimationTimer;
import javafx.geometry.Point2D;
import javafx.scene.input.KeyCode;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import sample.controller.EnemyController;
import sample.controller.PlayerController;
import sample.gameobjects.DashLine;
import sample.gameobjects.Enemy;
import sample.gameobjects.Indicator;
import sample.gameobjects.Player;
import sample.screens.GameScreen;

import java.awt.*;
import java.util.ArrayList;
import java.util.List;

import static sample.Commons.BOARD_HEIGTH;
import static sample.Commons.BOARD_WIDTH;

public class GameScreenLogic {
    private int level = 5;
    private int score;
    private DashLine dashLine = new DashLine();
    private EnemyController enemyController = new EnemyController();
    private Player player = new Player();
    private List<Enemy> enemyList = new ArrayList<>();
    private Indicator indicator = new Indicator();
    AnimationTimer animationTimer;
    public void doGameCycle(GameScreen gameScreen) {
        Rectangle rectangle = new Rectangle(40, 30, Color.BLACK);
        if (Math.random() < 0.05 && enemyList.size() < level) /* Only spawn enemy if random number < 0.05 */ {
            if (Math.random() > 0.025) {
                Enemy enemy = new Enemy();
                enemyController.addEnemy(enemy, BOARD_WIDTH*Math.random(), 20, gameScreen);
                enemyList.add(enemy);
            }
        }
        for (Enemy enemy: enemyList) {
            enemy.turnAtEdge(gameScreen);
            if (player.isColliding(enemy)) {
                player.setAlive(false);
                //animationTimer.stop();
                //label.setText("Game Over, Score:" + score);
                gameScreen.getChildren().removeAll(enemy.getView(), player.getView());
            }
            if (dashLine.isColliding(enemy)) {
                enemy.setAlive(false);
                setScore(score++);
                gameScreen.getChildren().remove(enemy.getView());
            }
        }
        enemyList.removeIf(Enemy::isDead);
        enemyList.forEach(Enemy::update);
        player.update();
    }
    public void setScore(int score) {
        this.score = score;
    }
    public int getScore() {
        return score;
    }
    public void startGameLoop(GameScreen gameScreen) {
        initializePlayer(gameScreen);
        animationTimer = new AnimationTimer() {
            @Override
            public void handle(long now) {
                doGameCycle(gameScreen);
            }
        };
        gameScreen.setOnMousePressed(event -> {
            animationTimer.start();
        });
    }
    public void initializePlayer(GameScreen gameScreen) {
        player = new Player();
        player.setVelocity(new Point2D(1,0));
        player.getView().setTranslateX(BOARD_WIDTH/3);
        player.getView().setTranslateY(BOARD_HEIGTH/2);
        gameScreen.getChildren().add(player.getView());
    }
    public void playerControls(GameScreen gameScreen) {
        gameScreen.setOnKeyPressed(keyEvent -> {
            if (keyEvent.getCode() == KeyCode.A) {
                System.out.println("A wurde gedr√ºckt, GameScreenLogic");
                player.rotateLeft();
            }
            if (keyEvent.getCode() == KeyCode.D) {
                player.rotateRight();
            }
        });
    }
    public void rotatePlayerLeft() {
        player.rotateLeft();
    }
    public double getPlayerX() {
        return player.getX();
    }
}
