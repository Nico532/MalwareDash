package sample.logic;

import javafx.animation.AnimationTimer;
import javafx.geometry.Point2D;
import javafx.scene.control.Label;
import javafx.scene.input.KeyCode;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import sample.Commons;
import sample.controller.EnemyController;
import sample.gameobjects.DashLine;
import sample.gameobjects.Enemy;
import sample.gameobjects.Indicator;
import sample.screens.GameScreen;

import java.util.ArrayList;
import java.util.List;
import java.util.Observable;
import java.util.Observer;

import static sample.Commons.*;

public class GameScreenLogic implements Observer {
    private Label startText = new Label();
    private boolean checkDash = false;
    private int level = 5;
    private int score;
    private EnemyController enemyController = new EnemyController();
    private List<Enemy> enemyList = new ArrayList<>();
    private Indicator indicator = new Indicator();
    AnimationTimer animationTimer;
    public void doGameCycle(GameScreen gameScreen) {
        Rectangle rectangle = new Rectangle(40, 30, Color.BLACK);
        if (Math.random() < 0.05 && enemyList.size() < level) /* Only spawn enemy if random number < 0.05 */ {
            if (Math.random() > 0.025) {
                Enemy enemy = new Enemy();
                enemyController.addEnemy(enemy, BOARD_WIDTH*Math.random(), 20, gameScreen);
                enemyList.add(enemy);
            }
        }
        for (Enemy enemy: enemyList) {
            enemy.turnAtEdge(gameScreen);
            if (Commons.player.isColliding(enemy)) {
                Commons.player.setAlive(false);
                //animationTimer.stop();
                //label.setText("Game Over, Score:" + score);
                gameScreen.getChildren().removeAll(enemy.getView(), Commons.player.getView());
            }
        }
        if (checkDash) {
            for (Enemy enemy : enemyList) {
                if (dashLine.isColliding(enemy)) {
                    enemy.setAlive(false);
                    //setScore(score++);
                    gameScreen.getChildren().remove(enemy.getView());
                }
            }
            checkDash = false;
        }
        enemyList.removeIf(Enemy::isDead);
        enemyList.forEach(Enemy::update);
        Commons.player.update();
    }
    public void setScore(int score) {
        this.score = score;
    }
    public int getScore() {
        return score;
    }
    public void startGameLoop(GameScreen gameScreen) {
        initializePlayer(gameScreen);
        animationTimer = new AnimationTimer() {
            @Override
            public void handle(long now) {
                doGameCycle(gameScreen);
            }
        };
        gameScreen.setOnMousePressed(event -> {
            animationTimer.start();
        });
    }
    public void initializePlayer(GameScreen gameScreen) {
        Commons.player.setVelocity(new Point2D(1,0));
        Commons.player.getView().setTranslateX(PLAYER_START_X);
        Commons.player.getView().setTranslateY(PLAYER_START_Y);
        gameScreen.getChildren().addAll(Commons.player.getView(), rangeIndicator, dashLine);
    }
    public void rotatePlayerLeft() {
        Commons.player.rotateLeft();
    }
    public double getPlayerX() {
        return Commons.player.getX();
    }

    @Override
    public void update(Observable o, Object arg) {
        checkDash = true;
        System.out.println(""+checkDash);

    }
}
